# 使用指南

## 项目要求（Embedded Challenge Fall 2025）

本项目需要实现以下功能：

1. **检测三种帕金森症状**：
   - **Tremor（震颤）**：3-5Hz 频率范围的节律性振荡
   - **Dyskinesia（运动障碍）**：5-7Hz 频率范围的舞蹈样动作
   - **Freezing of Gait (FOG)（冻结步态）**：通过步态检测、步频等检测突然冻结

2. **技术规格**：
   - 采样率：52Hz
   - 加速度计范围：±2G
   - 数据窗口：3 秒（156 样本）
   - 使用 FFT 分析频率分布

3. **BLE 通信**：
   - 单个 BLE 服务
   - 三个不同的 BLE 特征值（Tremor、Dyskinesia、FOG）
   - 传输检测状态和强度级别

4. **提交要求**：
   - PlatformIO 项目目录
   - 1 分钟视频演示

---

## 第一部分：上传到 GitHub

### 1. 初始化 Git（如果还没有）

**Windows (PowerShell 或 Git Bash):**
```bash
cd embedded
git init
```

### 2. 添加文件并提交

```bash
git add .
git commit -m "Initial commit: Parkinson symptom detection system"
```

### 3. 在 GitHub 创建仓库

1. 登录 GitHub
2. 点击右上角 `+` → `New repository`
3. 输入仓库名称（如 `parkinson-detector`）
4. 选择 Public 或 Private
5. 不要勾选 "Initialize with README"
6. 点击 `Create repository`

### 4. 连接并推送

```bash
# 添加远程仓库（替换 YOUR_USERNAME 和 REPO_NAME）
git remote add origin https://github.com/YOUR_USERNAME/REPO_NAME.git

# 推送代码
git branch -M main
git push -u origin main
```

---

## 第二部分：在有板子的电脑上运行

### 前提条件

- ✅ VSCode 已安装
- ✅ PlatformIO IDE 扩展已安装（在 VSCode 扩展市场搜索 "PlatformIO IDE" 安装）
- ✅ Python 3.11.7 已安装（Windows/Mac/Linux 都支持）
- ✅ ST B-L475E-IOT01A1 开发板
- ✅ **Windows 用户**：需要安装 Git（包含 Git Bash）或使用 PowerShell

### 步骤 1：从 GitHub 下载项目

**Windows (PowerShell 或 Git Bash):**
```bash
# 克隆项目（替换 YOUR_USERNAME 和 REPO_NAME）
git clone https://github.com/YOUR_USERNAME/REPO_NAME.git

# 进入项目目录
cd REPO_NAME
```

**注意**：Windows 用户可以使用 PowerShell、Git Bash 或 CMD，命令相同。

### 步骤 2：用 VSCode 打开项目

1. 打开 VSCode
2. `文件` → `打开文件夹...` → 选择项目文件夹
3. 等待 PlatformIO 自动初始化（首次需要下载工具链，可能需要几分钟）

**重要提示**：
- 如果看到 `native` 环境编译失败（`g++` 未找到），**这是正常的，可以忽略**
- `native` 环境只是用于电脑端测试，**不是必需的**
- **硬件环境 `disco_l475vg_iot01a` 编译成功即可**，这是实际使用的环境

### 步骤 3：连接开发板

1. 用 USB 线连接 ST B-L475E-IOT01A1 开发板到电脑
2. 确认开发板电源指示灯亮起

### 步骤 4：编译和上传

**重要：确保选择了正确的环境**

1. **检查环境选择**：
   - 查看 VSCode 底部状态栏，PlatformIO 区域应该显示 `disco_l475vg_iot01a`
   - 如果显示其他环境，点击环境名称，选择 `disco_l475vg_iot01a`

**方法 1：使用状态栏按钮（最简单）**

1. 确保环境是 `disco_l475vg_iot01a`
2. 点击 **✓ (Build)** 按钮编译（只编译硬件环境）
3. 等待编译成功
4. 点击 **→ (Upload)** 按钮上传到开发板

**方法 2：使用快捷键**

- 编译：`Alt+Ctrl+B` (Windows/Linux) 或 `Cmd+Alt+B` (Mac)
- 上传：`Alt+Ctrl+U` (Windows/Linux) 或 `Cmd+Alt+U` (Mac)

**Windows 用户注意**：如果快捷键不工作，可能是快捷键冲突，使用状态栏按钮或命令面板即可。

**方法 3：使用命令面板**

1. 按 `Ctrl+Shift+P` (Mac: `Cmd+Shift+P`)
2. 输入 `PlatformIO: Upload`
3. 选择 `PlatformIO: Upload`（确保选择的是 `disco_l475vg_iot01a` 环境）

**方法 4：使用终端命令（最可靠）**

在 VSCode 终端中运行：

```bash
# 只编译硬件环境
pio run -e disco_l475vg_iot01a

# 上传到开发板
pio run -e disco_l475vg_iot01a -t upload
```

这样可以确保只编译和上传硬件环境，不会受到 native 环境的影响。

### 步骤 5：查看运行结果

1. 点击状态栏的 **🔌 (Serial Monitor)** 按钮
2. 或使用快捷键：`Alt+Ctrl+S` (Windows/Linux) 或 `Cmd+Alt+S` (Mac)

**预期输出：**
```
=== Parkinson's Disease Symptom Detection System ===
Sensor initialization successful (I2C address: 0xD6)
BLE initialization successful, device name: ParkinsonDetector
System initialization complete. Starting data acquisition...

=== Detection Results ===
Tremor: NO (Intensity: 0.00)
Dyskinesia: NO (Intensity: 0.00)
Freezing of Gait: NO (Intensity: 0.00)
```

程序每 3 秒输出一次检测结果。

---

## 第三部分：测试板子功能

### 项目定义的症状指标（根据项目要求）

根据 **Embedded Challenge Fall 2025** 项目要求，系统检测以下三种帕金森症状：

1. **Tremor（震颤）**
   - 频率范围：**3-5Hz**
   - 典型频率：**4Hz**
   - 检测阈值：强度 > 0.25 且 > 1.2x 背景噪声
   - 特征：影响主导手臂的节律性振荡

2. **Dyskinesia（运动障碍）**
   - 频率范围：**5-7Hz**
   - 典型频率：**6Hz**
   - 检测阈值：强度 > 0.25 且 > 1.2x 背景噪声
   - 特征：舞蹈样动作，通常由过量多巴胺药物引起

3. **Freezing of Gait (FOG)（冻结步态）**
   - 检测方法：步态分析 + 方差分析（非频率检测）
   - 条件1：之前有行走活动（步频 > 0.3 步/秒）
   - 条件2：突然停止（数据窗口后三分之一方差低）
   - 条件3：方差减少（后三分之一 < 前三分之一的 50%）
   - 特征：行走一段时间后身体突然冻结，晚期症状

### 测试 1：查看程序是否正常运行

1. **打开串口监视器**（如果还没打开）：
   - 点击状态栏 **🔌 (Serial Monitor)** 按钮

2. **检查初始化信息**：
   - 应该看到传感器初始化成功信息
   - 应该看到 BLE 初始化信息（如果成功）
   - 应该看到 "System initialization complete"

3. **检查检测结果输出**：
   - 每 3 秒应该输出一次检测结果（3 秒数据窗口）
   - 如果板子静止，应该显示所有症状为 "NO"

**正常输出示例：**
```
=== Parkinson's Disease Symptom Detection System ===
Sensor initialization successful (I2C address: 0xD6)
BLE initialization successful, device name: ParkinsonDetector
System initialization complete. Starting data acquisition...

=== Detection Results ===
Tremor: NO (Intensity: 0.00)
Dyskinesia: NO (Intensity: 0.00)
Freezing of Gait: NO (Intensity: 0.00)
```

### 测试 2：测试震颤检测（Tremor）

**项目定义**：3-5Hz 频率范围，典型 4Hz

**测试方法**：
1. 拿起开发板
2. **模拟震颤**：用手快速、小幅地左右或上下晃动开发板
   - **频率要求**：约 **4Hz**（每秒 4 次来回）
   - **幅度**：小幅晃动（不要太大）
   - **持续时间**：至少 **3 秒**（一个检测窗口）
3. 观察串口输出

**预期结果**：
```
=== Detection Results ===
Tremor: YES (Intensity: 0.XX)  ← 应该检测到震颤（3-5Hz 范围内）
Dyskinesia: NO (Intensity: 0.00)
Freezing of Gait: NO (Intensity: 0.00)
```

### 测试 3：测试运动障碍检测（Dyskinesia）

**项目定义**：5-7Hz 频率范围，典型 6Hz

**测试方法**：
1. 拿起开发板
2. **模拟运动障碍**：用手更快地晃动开发板
   - **频率要求**：约 **6Hz**（每秒 6 次来回）
   - **幅度**：可以比震颤稍大（舞蹈样动作）
   - **持续时间**：至少 **3 秒**（一个检测窗口）
3. 观察串口输出

**预期结果**：
```
=== Detection Results ===
Tremor: NO (Intensity: 0.00)
Dyskinesia: YES (Intensity: 0.XX)  ← 应该检测到运动障碍（5-7Hz 范围内）
Freezing of Gait: NO (Intensity: 0.00)
```

### 测试 4：测试冻结步态检测（Freezing of Gait）

**项目定义**：基于步态分析，不是频率检测

**测试方法**：
1. 拿起开发板
2. **模拟行走**：缓慢地前后或左右移动开发板
   - **模拟走路动作**：有节奏的移动（步频 > 0.3 步/秒）
   - **持续时间**：至少 **1-2 秒**
3. **突然停止**：立即停止所有移动，保持完全静止
   - **静止持续时间**：至少 **1-2 秒**
   - **总时间**：需要覆盖 3 秒检测窗口
4. 观察串口输出

**预期结果**：
```
=== Detection Results ===
Tremor: NO (Intensity: 0.00)
Dyskinesia: NO (Intensity: 0.00)
Freezing of Gait: YES (Intensity: 0.XX)  ← 应该检测到冻结步态
```

**注意**：FOG 检测基于步态分析，需要先有行走活动（步频 > 0.3 步/秒），然后突然停止（方差显著降低）。

### 测试 5：测试 BLE 功能（项目要求）

**项目要求**：使用 BLE 传输三个条件的信息到移动设备，使用三个不同的 BLE 特征值在单个服务上。

**目的**：验证蓝牙通信是否正常工作

**方法 1：使用手机 App（推荐，用于视频演示）**

1. **下载 nRF Connect App**：
   - iOS：App Store 搜索 "nRF Connect"
   - Android：Google Play 搜索 "nRF Connect"

2. **连接设备**：
   - 打开 nRF Connect
   - 点击 "Scan" 扫描蓝牙设备
   - 找到 "ParkinsonDetector" 设备
   - 点击连接

3. **订阅特征值（项目要求：三个不同的 BLE 特征值）**：
   - 连接后，找到 **单个服务**下的三个特征值：
     - **Tremor**（UUID: 19B10001-E8F2-537E-4F6C-D104768A1214）
     - **Dyskinesia**（UUID: 19B10002-E8F2-537E-4F6C-D104768A1214）
     - **FOG**（UUID: 19B10003-E8F2-537E-4F6C-D104768A1214）
   - 点击每个特征值右侧的"订阅"图标（三个点或通知图标）
   - 实时查看检测结果和强度级别

**方法 2：使用电脑蓝牙工具**

- Windows：可以使用 "Bluetooth LE Explorer" 或 "nRF Connect Desktop"
- Mac：可以使用 "LightBlue" 或 "nRF Connect Desktop"

### 测试检查清单

✅ **基础功能**：
- [ ] 程序成功上传
- [ ] 串口监视器能正常显示输出
- [ ] 传感器初始化成功
- [ ] 每 3 秒输出一次检测结果

✅ **传感器测试**：
- [ ] 静止时所有症状显示 "NO"
- [ ] 快速晃动（4Hz）能检测到震颤
- [ ] 更快晃动（6Hz）能检测到运动障碍
- [ ] 先移动后停止能检测到冻结步态

✅ **BLE 测试**（项目要求：必须功能）：
- [ ] 手机能搜索到 "ParkinsonDetector" 设备
- [ ] 能成功连接
- [ ] 能订阅三个特征值并接收通知
- [ ] 检测结果和强度级别能实时传输到手机
- [ ] 三个特征值在单个服务下（符合项目要求）

### 故障排查

**如果传感器初始化失败**：
- 检查开发板是否正确连接
- 重新插拔 USB 线
- 检查开发板上的 LSM6DSL 传感器是否正常

**如果检测不到症状**：
- **震颤**：确保晃动频率在 3-5Hz 范围内（约 4Hz，每秒 4 次）
- **运动障碍**：确保晃动频率在 5-7Hz 范围内（约 6Hz，每秒 6 次）
- 确保晃动幅度足够（不要太轻微）
- 保持晃动至少 3 秒（一个检测窗口）
- **冻结步态**：需要先有行走活动（步频 > 0.3 步/秒），然后突然停止

**如果 BLE 无法连接**：
- 检查 BLE 初始化是否成功（看串口输出）
- 确保手机蓝牙已开启
- 尝试重启开发板
- 如果 BLE 初始化失败，这是警告，不影响核心检测功能

---

## 常见问题

### 找不到开发板

- 检查 USB 连接
- **Windows**：检查设备管理器中是否有 "STM32 STLink" 或 "COM" 端口
- 运行 `pio device list` 查看设备（在 VSCode 终端或 PowerShell/Git Bash）
- 如果看到设备，在状态栏 PlatformIO 区域选择 `Upload to specific port`
- **Windows**：如果提示权限错误，可能需要以管理员身份运行 VSCode

### 上传失败

**常见原因和解决方法：**

1. **环境选择错误**：
   - 确保选择了 `disco_l475vg_iot01a` 环境，不是 `native`
   - 在状态栏检查环境名称
   - 使用终端命令：`pio run -e disco_l475vg_iot01a -t upload`

2. **开发板未连接**：
   - 检查 USB 线是否连接
   - 检查开发板电源指示灯是否亮起
   - 运行 `pio device list` 查看是否检测到设备

3. **驱动问题（Windows）**：
   - 检查设备管理器中是否有 "STM32 STLink" 或 "COM" 端口
   - 如果有黄色感叹号，需要安装 ST-Link 驱动
   - 下载地址：https://www.st.com/en/development-tools/stsw-link009.html

4. **权限问题（Linux）**：
   - 运行：`sudo usermod -a -G dialout $USER`
   - 重新登录或重启

5. **清理后重新编译**：
   ```bash
   pio run -e disco_l475vg_iot01a -t clean
   pio run -e disco_l475vg_iot01a
   pio run -e disco_l475vg_iot01a -t upload
   ```

6. **手动指定端口**：
   ```bash
   # 先查看设备
   pio device list
   
   # 手动指定端口上传（替换 COM3 为你的端口）
   pio run -e disco_l475vg_iot01a -t upload --upload-port COM3
   ```
   
   **或者修改 platformio.ini**：
   在 `[env:disco_l475vg_iot01a]` 部分添加：
   ```ini
   upload_port = COM3
   monitor_port = COM3
   ```
   这样就不需要每次都指定端口了。

### 编译错误

**如果 `native` 环境编译失败（`g++` 未找到）**：
- **这是正常的，可以忽略**
- `native` 环境需要 C++ 编译器（g++），Windows 上可能没有安装
- **不影响硬件环境使用**，只需要 `disco_l475vg_iot01a` 环境成功即可

**如果需要修复 `native` 环境（可选）**：
- 安装 MinGW-w64 或 MSYS2（提供 g++ 编译器）
- 或者使用 WSL（Windows Subsystem for Linux）
- 但这不是必需的，因为硬件环境已经可以正常使用

**其他编译错误**：
- 确保网络连接正常（首次编译需要下载工具链）
- 清理缓存：命令面板 → `PlatformIO: Clean`
- 重新编译

---

## 快速参考

**上传代码到 GitHub：**
```bash
git add .
git commit -m "Update"
git push
```

**在有板子的电脑上（Windows/Mac/Linux 通用）：**
1. `git clone` 下载项目
2. VSCode 打开项目
3. 连接开发板（USB）
4. 点击状态栏 **→ (Upload)** 按钮上传
5. 点击状态栏 **🔌 (Serial Monitor)** 按钮查看输出

---

## 第四部分：视频演示准备（项目提交要求）

### 视频要求

根据项目要求，需要提交 **1 分钟视频演示**，展示设备功能。

### 视频内容建议

**建议结构（1 分钟）：**

1. **开场（5 秒）**：
   - 展示开发板和连接
   - 简要说明项目目标

2. **演示震颤检测（15 秒）**：
   - 展示串口监视器输出
   - 手动晃动开发板（4Hz）
   - 展示检测到震颤（"Tremor: YES"）
   - 展示 BLE 连接（如果可能）

3. **演示运动障碍检测（15 秒）**：
   - 更快晃动开发板（6Hz）
   - 展示检测到运动障碍（"Dyskinesia: YES"）
   - 展示强度级别变化

4. **演示冻结步态检测（15 秒）**：
   - 先移动开发板（模拟行走）
   - 突然停止
   - 展示检测到冻结步态（"Freezing of Gait: YES"）

5. **BLE 功能展示（10 秒）**：
   - 展示手机连接（nRF Connect）
   - 展示实时接收检测结果
   - 展示三个特征值

### 录制技巧

- **串口监视器**：确保输出清晰可见
- **手机屏幕**：如果展示 BLE，确保手机屏幕清晰
- **开发板动作**：确保晃动动作清晰可见
- **时间控制**：严格控制 1 分钟，可以提前排练

### 视频提交

- 格式：MP4 或常见视频格式
- 时长：1 分钟（±5 秒）
- 内容：展示所有三个检测功能
- 质量：清晰可见，音频可选

---

## Windows 特别说明

✅ **完全支持 Windows**：硬件编译和上传在 Windows 上完全正常  
✅ **PlatformIO 支持**：PlatformIO 原生支持 Windows  
⚠️ **Native 测试环境**：`native` 测试环境在 Windows 上可能不可用（使用了 Unix 特定 API），但不影响硬件编译和运行  
✅ **使用硬件环境**：直接使用 `disco_l475vg_iot01a` 环境即可，无需测试环境
