# ST B-L475E-IOT01A1 硬件实现说明

## 板子信息

- **开发板**: ST B-L475E-IOT01A1 (STM32L475VG IoT Discovery)
- **PlatformIO Board**: `disco_l475vg_iot01a`
- **框架**: Mbed OS

## 板载传感器

### LSM6DSL 加速度计/陀螺仪

- **接口**: I2C
- **I2C地址**: 
  - 主地址: 0xD6 (SA0 = 1, 默认)
  - 备用地址: 0xD4 (SA0 = 0)
- **I2C引脚配置**:
  - **方法1 (I2C1)**: PB6 = SCL, PB7 = SDA
  - **方法2 (I2C3)**: PC0 = SCL, PC1 = SDA (备用)
- **WHO_AM_I寄存器值**: 0x6A

## 已实现的硬件驱动

### 1. LSM6DSL传感器驱动

**文件**: `src/LSM6DSL.h` 和 `src/LSM6DSL.cpp`

**功能**:
- I2C通信（支持自动地址检测）
- 传感器初始化
- 加速度计数据读取（±2g量程，52Hz采样率）
- 陀螺仪数据读取（±250dps量程，52Hz采样率）

**配置**:
- 加速度计: ±2g, 52Hz ODR
- 陀螺仪: ±250dps, 52Hz ODR
- I2C速度: 400kHz

### 2. SensorManager集成

**文件**: `src/SensorManager.cpp`

**已实现**:
- 自动I2C引脚检测（先尝试I2C1，失败后尝试I2C3）
- LSM6DSL对象创建和初始化
- 传感器数据读取接口
- 自动I2C地址检测（0xD6或0xD4）

### 3. BLE通信

**文件**: `src/BLEManager.cpp`

**已实现**:
- BLE初始化
- GATT服务创建
- 三个特征值（震颤、运动障碍、冻结步态）
- 数据广播和通知

**BLE服务UUID**: `19B10000-E8F2-537E-4F6C-D104768A1214`
**特征值UUID**:
- 震颤: `19B10001-E8F2-537E-4F6C-D104768A1214`
- 运动障碍: `19B10002-E8F2-537E-4F6C-D104768A1214`
- 冻结步态: `19B10003-E8F2-537E-4F6C-D104768A1214`

## 使用步骤

### 1. 连接开发板

1. 用USB线连接ST B-L475E-IOT01A1开发板
2. 确保系统识别设备（ST-LINK）

### 2. 编译程序

```bash
pio run -e disco_l475vg_iot01a
```

### 3. 上传到开发板

```bash
pio run -e disco_l475vg_iot01a -t upload
```

### 4. 监控串口输出

```bash
pio device monitor
```

串口设置: 115200 baud

## 预期输出

程序启动后，串口应该显示：

```
=== 帕金森症状检测系统启动 ===
传感器初始化成功 (I2C地址: 0xD6)
BLE初始化成功，设备名称: ParkinsonDetector
系统初始化完成，开始数据采集...

=== 检测结果 ===
震颤: 否 (强度: 0.00)
运动障碍: 否 (强度: 0.00)
冻结步态: 否 (强度: 0.00)
```

## BLE连接

### 使用手机APP连接

1. 打开手机蓝牙
2. 搜索设备 "ParkinsonDetector"
3. 连接后可以读取三个特征值：
   - 震颤状态和强度
   - 运动障碍状态和强度
   - 冻结步态状态和强度

### 使用nRF Connect (推荐)

1. 下载 nRF Connect APP
2. 扫描并连接 "ParkinsonDetector"
3. 查看服务 `19B10000-E8F2-537E-4F6C-D104768A1214`
4. 订阅通知以接收实时数据

## 故障排除

### 传感器初始化失败

**症状**: 串口显示 "传感器初始化失败!"

**可能原因**:
1. I2C引脚配置错误
2. 传感器未正确连接
3. I2C地址不正确

**解决方法**:
1. 代码会自动尝试两个I2C总线和两个地址
2. 如果都失败，检查硬件连接
3. 确认传感器是否正常工作

**调试信息**:
- 查看串口输出的I2C地址信息
- 检查WHO_AM_I寄存器返回值

### BLE初始化失败

**症状**: 串口显示 "BLE初始化失败"

**可能原因**:
1. BLE模块未初始化
2. 服务UUID冲突
3. Mbed BLE库问题

**解决方法**:
- 检查Mbed BLE库是否正确链接
- 确认UUID唯一性
- 重启开发板

### 编译错误

**可能原因**:
1. Mbed BLE库缺失
2. 头文件路径错误
3. I2C引脚定义错误

**解决方法**:
```bash
# 清理并重新编译
pio run -e disco_l475vg_iot01a -t clean
pio run -e disco_l475vg_iot01a
```

如果I2C引脚定义错误，可以手动修改 `SensorManager.cpp` 中的引脚定义。

## 代码结构

```
src/
├── LSM6DSL.h/cpp          # LSM6DSL传感器驱动
├── SensorManager.h/cpp    # 传感器管理（已集成LSM6DSL）
├── BLEManager.h/cpp       # BLE通信管理
├── SymptomDetector.h/cpp  # 症状检测算法
├── FFTProcessor.h/cpp     # FFT频率分析
└── main.cpp               # 主程序
```

## I2C引脚配置说明

如果默认引脚不工作，可以手动修改 `SensorManager.cpp` 中的 `initHardware()` 函数：

```cpp
// 选项1: I2C1 (PB6=SCL, PB7=SDA) - 默认
i2c = new I2C(PB_7, PB_6);

// 选项2: I2C3 (PC0=SCL, PC1=SDA) - 备用
i2c = new I2C(PC_1, PC_0);

// 选项3: 如果板级支持包提供了预定义引脚
// i2c = new I2C(I2C_SDA, I2C_SCL);
```

## 下一步优化

1. **添加LED指示**: 使用板载LED显示检测状态
2. **添加按钮控制**: 使用板载按钮启动/停止检测
3. **数据记录**: 将检测结果保存到Flash
4. **低功耗优化**: 优化功耗以延长电池使用时间
5. **校准功能**: 添加传感器校准功能
