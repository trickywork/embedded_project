# 硬件部署指南 - 连接开发板并运行程序

## 📋 前置准备

### 1. 硬件检查
- ✅ ST B-L475E-IOT01A1 开发板
- ✅ USB数据线（用于连接电脑和开发板）
- ✅ 确保开发板电源正常（USB供电或外部电源）

### 2. 软件检查
- ✅ PlatformIO已安装
- ✅ 项目代码已准备好
- ✅ 开发板驱动已安装（通常Windows/Mac会自动识别）

## 🔌 第一步：连接开发板

### 物理连接
1. 使用USB数据线连接开发板到电脑
2. 开发板上的LED应该会亮起（表示已供电）
3. 检查开发板上的跳线设置（通常默认设置即可）

### 验证连接
```bash
# 查看连接的设备
pio device list
```

你应该能看到类似这样的输出：
```
/dev/tty.usbmodem... (STMicroelectronics STLink Virtual COM Port)
```

## 🔧 第二步：配置PlatformIO

### 检查platformio.ini配置

确保你的 `platformio.ini` 包含硬件环境：

```ini
[env:disco_l475vg_iot01a]
platform = ststm32
board = disco_l475vg_iot01a
framework = mbed
monitor_speed = 115200
```

### 验证环境
```bash
# 检查环境是否正确配置
pio run -e disco_l475vg_iot01a --verbose
```

## 🚀 第三步：编译程序

### 编译硬件版本
```bash
# 编译硬件程序（使用disco_l475vg_iot01a环境）
pio run -e disco_l475vg_iot01a
```

**编译成功标志**:
```
Building in release mode
Checking size .pio/build/disco_l475vg_iot01a/firmware.elf
Memory Usage -> Available: RAM: 128 KB, Flash: 1024 KB
```

### 如果编译失败
1. **检查依赖**: 确保所有库都已安装
2. **清理重建**: 
   ```bash
   pio run -e disco_l475vg_iot01a -t clean
   pio run -e disco_l475vg_iot01a
   ```

## 📤 第四步：上传程序到开发板

### 方法1：使用PlatformIO上传（推荐）
```bash
# 编译并上传
pio run -e disco_l475vg_iot01a -t upload
```

### 方法2：分步上传
```bash
# 先编译
pio run -e disco_l475vg_iot01a

# 再上传
pio run -e disco_l475vg_iot01a -t upload
```

**上传成功标志**:
```
Uploading .pio/build/disco_l475vg_iot01a/firmware.bin
...
*** [upload] Success
```

### 如果上传失败

#### 问题1：找不到设备
```bash
# 检查设备连接
pio device list

# 如果看不到设备，尝试：
# 1. 重新插拔USB线
# 2. 检查USB线是否支持数据传输（有些只能充电）
# 3. 检查驱动是否安装
```

#### 问题2：权限错误（Linux/Mac）
```bash
# 添加用户到dialout组（Linux）
sudo usermod -a -G dialout $USER
# 然后重新登录

# Mac通常不需要额外权限
```

#### 问题3：STLink驱动问题
- **Windows**: 安装ST-Link驱动
- **Mac**: 通常系统自带驱动
- **Linux**: 可能需要安装 `stlink-tools`

## 📺 第五步：查看串口输出

### 方法1：使用PlatformIO Monitor（推荐）
```bash
# 打开串口监视器
pio device monitor -e disco_l475vg_iot01a
```

### 方法2：编译+上传+监视（一条命令）
```bash
# 上传并自动打开监视器
pio run -e disco_l475vg_iot01a -t upload && pio device monitor -e disco_l475vg_iot01a
```

### 方法3：使用其他串口工具
- **Windows**: PuTTY, Tera Term
- **Mac/Linux**: `screen`, `minicom`, `cu`
  ```bash
  # 使用screen（Mac/Linux）
  screen /dev/tty.usbmodem* 115200
  
  # 退出screen: Ctrl+A, 然后按K, 再按Y确认
  ```

### 预期输出
程序运行后，你应该看到类似这样的输出：

```
=== Parkinson's Disease Symptom Detection System ===
Initializing sensor hardware (LSM6DSL on ST B-L475E-IOT01A1)...
Sensor initialization successful (I2C address: 0xD6)
Initializing symptom detection algorithm...
Initializing BLE...
BLE initialization successful, device name: ParkinsonDetector
System initialization complete. Starting data acquisition...

=== Detection Results ===
Tremor: NO (Intensity: 0.12)
Dyskinesia: NO (Intensity: 0.08)
Freezing of Gait: NO (Intensity: 0.05)
```

## 🔄 完整工作流程

### 一键编译+上传+监视
```bash
# 创建别名（可选，添加到 ~/.bashrc 或 ~/.zshrc）
alias pio-upload='pio run -e disco_l475vg_iot01a -t upload && pio device monitor -e disco_l475vg_iot01a'

# 使用
pio-upload
```

### 或者使用脚本
创建一个 `upload.sh` 文件：

```bash
#!/bin/bash
echo "Building..."
pio run -e disco_l475vg_iot01a

echo "Uploading..."
pio run -e disco_l475vg_iot01a -t upload

echo "Opening monitor..."
pio device monitor -e disco_l475vg_iot01a
```

然后运行：
```bash
chmod +x upload.sh
./upload.sh
```

## 🐛 常见问题排查

### 问题1：传感器初始化失败

**症状**: 
```
ERROR: Sensor initialization failed!
```

**解决方案**:
1. 检查I2C连接（开发板通常已连接好）
2. 检查传感器地址（代码会自动尝试0xD6和0xD4）
3. 检查I2C引脚配置（代码会自动尝试I2C1和I2C3）

**调试方法**:
在 `SensorManager.cpp` 中添加更多调试信息：
```cpp
printf("Trying I2C1...\r\n");
// ... 如果失败
printf("Trying I2C3...\r\n");
```

### 问题2：BLE初始化失败

**症状**:
```
WARNING: BLE initialization failed, continuing in simulation mode
```

**解决方案**:
1. 检查开发板是否有BLE模块（B-L475E-IOT01A1应该有）
2. 检查Mbed BLE库是否正确安装
3. 可能需要重启开发板

### 问题3：没有串口输出

**可能原因**:
1. 波特率不匹配（应该是115200）
2. 串口被其他程序占用
3. 程序没有运行（检查LED状态）

**解决方案**:
```bash
# 检查串口设置
pio device monitor -e disco_l475vg_iot01a --baud 115200

# 或者手动指定端口
pio device monitor --port /dev/tty.usbmodem* --baud 115200
```

### 问题4：程序运行但检测不到症状

**可能原因**:
1. 传感器数据正常，但没有症状信号
2. 阈值设置过高
3. 传感器安装方向不对

**调试方法**:
1. 查看原始传感器数据：
   ```cpp
   // 在main.cpp中添加
   printf("Accel: X=%.3f, Y=%.3f, Z=%.3f\r\n", 
          data.accelX, data.accelY, data.accelZ);
   ```

2. 手动触发测试：
   - 轻微摇晃开发板（模拟震颤）
   - 快速移动开发板（模拟运动障碍）
   - 先移动后静止（模拟FOG）

### 问题5：编译错误

**常见错误1**: 找不到Mbed库
```bash
# 解决方案：更新平台
pio platform update ststm32
```

**常见错误2**: 内存不足
```
Error: region RAM overflowed
```
解决方案：优化代码，减少缓冲区大小（如果可能）

## 📊 验证程序运行

### 检查清单

- [ ] 开发板LED正常闪烁
- [ ] 串口有输出
- [ ] 传感器初始化成功
- [ ] BLE初始化成功（或至少不报错）
- [ ] 每3秒输出一次检测结果
- [ ] 传感器数据在合理范围内（加速度约±2g，陀螺仪约±250dps）

### 测试传感器数据

正常静止状态下，你应该看到：
```
Accel: X≈0.0, Y≈0.0, Z≈1.0  (Z轴是重力)
Gyro: X≈0.0, Y≈0.0, Z≈0.0
```

### 测试症状检测

1. **测试震颤**: 轻微摇晃开发板（3-5Hz频率）
2. **测试运动障碍**: 快速移动开发板（5-7Hz频率）
3. **测试FOG**: 先移动开发板，然后突然静止

## 🔧 高级配置

### 修改串口波特率

在 `platformio.ini` 中：
```ini
[env:disco_l475vg_iot01a]
monitor_speed = 115200  # 可以改为其他值，如9600
```

### 启用详细调试

在 `platformio.ini` 中添加：
```ini
build_flags = 
    -D DEBUG_MODE
    -D MBED_OS
```

### 使用ST-Link工具（高级）

如果PlatformIO上传失败，可以尝试使用ST-Link工具：

```bash
# 安装stlink工具（Mac）
brew install stlink

# 上传
st-flash write .pio/build/disco_l475vg_iot01a/firmware.bin 0x8000000
```

## 📱 连接手机APP

### BLE连接步骤

1. **确保BLE已初始化**: 查看串口输出，应该看到：
   ```
   BLE initialization successful, device name: ParkinsonDetector
   BLE advertising started.
   ```

2. **在手机上搜索**: 
   - 打开蓝牙设置
   - 搜索设备，应该能看到 "ParkinsonDetector"

3. **连接设备**: 
   - 点击连接
   - 可能需要配对（PIN通常是0000或1234）

4. **读取特征值**: 
   - 使用BLE扫描APP（如nRF Connect）
   - 查找服务UUID: `19B10000-E8F2-537E-4F6C-D104768A1214`
   - 读取三个特征值：震颤、运动障碍、FOG

## 🎯 快速参考命令

```bash
# 1. 检查设备连接
pio device list

# 2. 编译
pio run -e disco_l475vg_iot01a

# 3. 上传
pio run -e disco_l475vg_iot01a -t upload

# 4. 监视串口
pio device monitor -e disco_l475vg_iot01a

# 5. 一键操作（编译+上传+监视）
pio run -e disco_l475vg_iot01a -t upload && pio device monitor -e disco_l475vg_iot01a

# 6. 清理重建
pio run -e disco_l475vg_iot01a -t clean
pio run -e disco_l475vg_iot01a
```

## 📝 注意事项

1. **首次上传**: 可能需要较长时间（编译和上传）
2. **重新上传**: 如果程序正在运行，上传会自动重启开发板
3. **串口监视器**: 如果关闭监视器，程序仍在运行
4. **电源**: 确保开发板有稳定电源
5. **USB线**: 使用质量好的USB线，确保数据传输稳定

## 🆘 获取帮助

如果遇到问题：

1. **查看编译输出**: 仔细阅读错误信息
2. **检查串口输出**: 查看程序运行日志
3. **验证硬件**: 确保开发板和传感器正常
4. **查阅文档**: 
   - Mbed OS文档
   - ST B-L475E-IOT01A1用户手册
   - PlatformIO文档

---

**祝你好运！** 🚀

